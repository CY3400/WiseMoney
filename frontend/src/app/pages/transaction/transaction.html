<div class="center-page">
    <div class="error border-danger" *ngIf="hasErrors()">
        <span *ngIf="errors.global" class="text-danger">{{ errors.global }}</span>
        <span *ngIf="errors.category" class="text-danger">{{ errors.category }}</span>
        <span *ngIf="errors.amount" class="text-danger">{{ errors.amount }}</span>
        <span *ngIf="errors.transactionDate" class="text-danger">{{ errors.transactionDate }}</span>
        <span *ngIf="errors.notes" class="text-danger">{{ errors.notes }}</span>
    </div>

    <div class="main">
        <h2>Transactions</h2>
        <p>Ajoutez, modifiez et visualisez vos différentes transactions</p>
        <form #form="ngForm" (ngSubmit)="onSubmit(form)">
            <div class="sub-main">
                <div>
                    <label for="category" [class.text-danger]="errors.category">Catégorie</label>
                    <select [disabled]="isSubmitting" id="category" name="category" [(ngModel)]="transaction.category" class="form-control" [class.border-danger]="errors.category">
                        <option [ngValue]="null" disabled>-- Sélectionner --</option>
                        <option *ngFor="let c of childOptions; trackBy: trackById" [ngValue]="c.id">
                            {{c.label}}
                        </option>
                    </select>
                </div>
                <div>
                    <label for="amount" [class.text-danger]="errors.amount">Montant</label>
                    <input [disabled]="isSubmitting" id="montant" name="montant" type="text" [(ngModel)]="transaction.amount" class="form-control" [class.border-danger]="errors.amount" (keydown)="common.validateNextValueKeydown($event,numberRegex,allowedKeys)" (paste)="common.validateNextValuePaste($event,numberRegex)"/>
                </div>
                <div>
                    <label for="transactionDate" [class.text-danger]="errors.transactionDate">Date de transaction</label>
                    <input [disabled]="isSubmitting" type="date" id="transactionDate" name="transactionDate" [(ngModel)]="transaction.transactionDate" class="form-control" [class.border-danger]="errors.transactionDate">
                </div>
            </div>
            <div class="sub-main">
                <div class="full">
                    <label for="notes" [class.text-danger]="errors.notes">Notes</label>
                    <textarea [disabled]="isSubmitting" rows="5" cols="50" id="notes" name="notes" [(ngModel)]="transaction.notes" class="form-control" [class.border-danger]="errors.notes"></textarea>
                </div>
            </div>

            <button class="primary" type="submit" [disabled]="isSubmitting" [attr.aria-busy]="isSubmitting">{{ isSubmitting ? 'Ajout...' : 'Ajouter'}}</button>
        </form>

        <hr>

        <table class="table categories">
            <colgroup>
                <col style="width:20%">
                <col style="width:15%">
                <col style="width:20%">
                <col style="width:30%">
                <col style="width:15%">
            </colgroup>
            <thead>
                <tr>
                    <th>Catégorie</th>
                    <th>Montant</th>
                    <th>Date</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody *ngIf="pagedRows.length; else emptyState">
                <ng-container>
                    <tr *ngFor="let r of pagedRows; trackBy: trackById">
                        <td class="cat">
                            {{ getCategoryLabel(r.category) }}
                        </td>
                        <td class="editName">
                            <input type="text" [(ngModel)]="r.editAmount" class="form-control" (keydown)="common.validateNextValueKeydown($event,numberRegex,allowedKeys)" (paste)="common.validateNextValuePaste($event,numberRegex)"/>
                        </td>
                        <td>
                            <input type="date" [(ngModel)]="r.editDate" class="form-control">
                        </td>
                        <td class="editName">
                            <textarea type="text" [(ngModel)]="r.editNote" class="form-control"></textarea>
                        </td>
                        <td class="btns">
                            <button class="secondary" type="button" (click)="modify(r)" [disabled]="r.saving || !r.editAmount || !r.editDate || !hasChanged(r)">Modifier</button>
                            <button class="btn-danger" type="button" (click)="delete(r.id)">Supprimer</button>
                        </td>
                    </tr>
                </ng-container>
            </tbody>

            <ng-template #emptyState>
                <tbody>
                    <tr>
                        <td class="emptyState" colspan="5">
                            Aucune transaction disponible
                        </td>
                    </tr>
                </tbody>
            </ng-template>
        </table>

        <div class="pager">
            <div class="left">
                <label>
                    Par page
                    <select [ngModel]="pageSize" (ngModelChange)="setPageSize($event)">
                        <option *ngFor="let s of pageSizes" [ngValue]="s">{{ s }}</option>
                    </select>
                </label>
                <span>{{ pageIndex * pageSize + 1 }} – {{ Math.min((pageIndex + 1) * pageSize, total) }} sur {{ total }}</span>
            </div>

            <div class="right">
                <button class="primary" type="button" (click)="goToPage(0)" [disabled]="pageIndex === 0">«</button>
                <button class="secondary" type="button" (click)="prev()" [disabled]="pageIndex === 0">‹</button>
                <span>Page {{ pageIndex + 1 }} / {{ totalPages }}</span>
                <button class="secondary" type="button" (click)="next()" [disabled]="pageIndex >= totalPages - 1">›</button>
                <button class="primary" type="button" (click)="goToPage(totalPages - 1)" [disabled]="pageIndex >= totalPages - 1">»</button>
            </div>
        </div>
    </div>
</div>