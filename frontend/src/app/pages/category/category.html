<div class="center-page">
    <div class="error border-danger" *ngIf="hasErrors()">
        <span *ngIf="errors.global" class="text-danger">{{ errors.global }}</span>
        <span *ngIf="errors.name" class="text-danger">{{ errors.name }}</span>
        <span *ngIf="errors.type" class="text-danger">{{ errors.type }}</span>
        <span *ngIf="errors.parent" class="text-danger">{{ errors.parent }}</span>
    </div>

    <div class="main">
        <h2>Catégorie</h2>
        <p>Ajoutez de nouvelles catégories</p>
        <form #form="ngForm" (ngSubmit)="onSubmit(form)">
            <div class="sub-main">
                <div>
                    <label for="name" [class.text-danger]="errors.name">Nom</label>
                    <input [disabled]="isSubmitting" id="name" name="name" type="text" [(ngModel)]="category.name" class="form-control" [class.border-danger]="errors.name" (keypress)="common.validateKey($event,allowedKeys,letterRegex)" (paste)="common.validatePaste($event,letterRegex)"/>
                </div>
                <div>
                    <label for="type" [class.text-danger]="errors.type">Type</label>
                    <select [disabled]="isSubmitting" id="type" name="type" [(ngModel)]="category.type" class="form-control" [class.border-danger]="errors.type" (ngModelChange)="onTypeChange($event)">
                        <option [ngValue]="null" disabled>-- Sélectionner --</option>
                        <option *ngFor="let t of categoryTypeOptions" [ngValue]="t">
                            {{labelOf(t)}}
                        </option>
                    </select>
                </div>
                <div>
                    <label for="parentId" [class.text-danger]="errors.parent">Parent</label>
                    <select [disabled]="isSubmitting" id="parentId" name="parentId" [(ngModel)]="category.parentId" class="form-control" (ngModelChange)="onParentSelected($event)" [class.border-danger]="errors.parent">
                        <option [ngValue]="null" disabled>-- Sélectionner --</option>
                        <option *ngFor="let t of parentOptions; trackBy: trackById" [ngValue]="t.id">
                            {{t.label}}
                        </option>
                    </select>
                </div>
            </div>

            <button class="primary" type="submit" [disabled]="isSubmitting" [attr.aria-busy]="isSubmitting">{{ isSubmitting ? 'Ajout...' : 'Ajouter'}}</button>
        </form>

        <hr>

        <table class="table categories">
            <colgroup>
                <col style="width:50%">
                <col style="width:50%">
            </colgroup>
            <thead>
                <tr>
                    <th class="tableName">Nom</th>
                    <th class="tableActions">Actions</th>
                </tr>
            </thead>

            <tbody *ngIf="pagedGroups.length; else emptyState">
                <ng-container *ngFor="let g of pagedGroups; trackBy: trackByGroup">
                    <tr class="group">
                        <td colspan="2">
                            {{g.parentLabel}}
                        </td>
                    </tr>

                    <tr *ngFor="let r of g.items; trackBy: trackByCat">
                        <td class="editName">
                            <input type="text" class="form-control" [(ngModel)]="r.editName" name="editName_{{r.id}}" (keypress)="common.validateKey($event, allowedKeys, letterRegex)" (paste)="common.validatePaste($event, letterRegex)" [disabled]="r.saving"/>
                        </td>

                        <td class="btns">
                            <button class="secondary" type="button" (click)="saveName(r)" [disabled]="r.saving || !r.editName.trim() || r.editName.trim().length < 2 || r.editName.trim().toLocaleLowerCase() === r.name.toLocaleLowerCase()">
                                Modifier
                            </button>
                            <button class="btn-danger" type="button" *ngIf="r.status === 1" (click)="toggleStatus(r)" [disabled]="r.saving">Désactiver</button>
                            <button class="primary" type="button" *ngIf="r.status === 0" (click)="toggleStatus(r)" [disabled]="r.saving">Activer</button>
                        </td>
                    </tr>
                </ng-container>
            </tbody>

            <ng-template #emptyState>
                <tbody>
                    <tr>
                        <td class="emptyState" colspan="2">
                            Aucune catégorie disponible
                        </td>
                    </tr>
                </tbody>
            </ng-template>
        </table>

        <div class="pager">
            <div class="left">
                <label>
                    Par page
                    <select [ngModel]="pageSize" (ngModelChange)="setPageSize($event)">
                        <option *ngFor="let s of pageSizes" [ngValue]="s">{{ s }}</option>
                    </select>
                </label>
                <span>{{ pageIndex * pageSize + 1 }} – {{ Math.min((pageIndex + 1) * pageSize, total) }} sur {{ total }}</span>
            </div>

            <div class="right">
                <button class="primary" type="button" (click)="goToPage(0)" [disabled]="pageIndex === 0">«</button>
                <button class="secondary" type="button" (click)="prev()" [disabled]="pageIndex === 0">‹</button>
                <span>Page {{ pageIndex + 1 }} / {{ totalPages }}</span>
                <button class="secondary" type="button" (click)="next()" [disabled]="pageIndex >= totalPages - 1">›</button>
                <button class="primary" type="button" (click)="goToPage(totalPages - 1)" [disabled]="pageIndex >= totalPages - 1">»</button>
            </div>
        </div>
    </div>
</div>